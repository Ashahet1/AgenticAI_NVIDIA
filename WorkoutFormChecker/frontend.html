<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Workout Form Checker</title>

  <!-- System font + Inter fallback for clarity -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    /* (styles same as before — readable defaults) */
    :root {
      --bg: #f6f8fb;
      --card-bg: #ffffff;
      --text: #0b2545;
      --muted: #475569;
      --accent: #2b6cb0;
      --accent-2: #7c3aed;
      --radius: 12px;
      --base-size: 18px;
      --shadow-1: 0 8px 24px rgba(2,6,23,0.06);
    }
    html[data-theme="dark"] {
      --bg: #0b1220;
      --card-bg: rgba(255,255,255,0.03);
      --text: #e6eef8;
      --muted: #cbd5e1;
      --accent: #60a5fa;
      --accent-2: #7c3aed;
    }

    html { font-size: var(--base-size); }
    body {
      margin: 0; padding: 32px;
      font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      background: var(--bg); color: var(--text);
      min-height:100vh; display:flex; justify-content:center; align-items:flex-start;
    }
    .container { width:100%; max-width:980px; display:grid; grid-template-columns: 1fr 360px; gap:24px; }
    .brand { grid-column:1/-1; display:flex; gap:14px; align-items:center; margin-bottom:6px; }
    .logo { width:56px; height:56px; border-radius:12px; display:flex; align-items:center; justify-content:center; background:linear-gradient(135deg,var(--accent),var(--accent-2)); box-shadow:var(--shadow-1); }
    .title h1{font-size:20px;margin:0 0 2px 0}
    .title p{margin:0;color:var(--muted);font-size:13px}
    .header-controls{margin-left:auto;display:flex;gap:10px;align-items:center}
    .theme-toggle{padding:8px 10px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);background:transparent;cursor:pointer}
    .card{border-radius:12px;padding:18px;background:var(--card-bg);box-shadow:var(--shadow-1);border:1px solid rgba(0,0,0,0.04)}
    textarea{width:100%;min-height:80px;padding:14px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);background:var(--card-bg);color:var(--text)}
    .controls{display:flex;gap:10px;margin-top:12px}
    .btn{background: linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;padding:12px 16px;border-radius:10px;border:none;cursor:pointer;min-height:44px}
    .btn.secondary{background:transparent;border:1px solid rgba(0,0,0,0.06);color:var(--muted)}
    .suggestions { display:flex; gap:8px; flex-wrap:wrap; margin-top:12px }
    .chip{padding:8px 10px;border-radius:999px;border:1px solid rgba(0,0,0,0.06);background:transparent;color:var(--muted);cursor:pointer}
    .panel{display:flex;flex-direction:column;gap:14px}
    .mini{padding:12px;border-radius:10px;background:var(--card-bg);border:1px solid rgba(0,0,0,0.04);color:var(--muted)}
    .progress-bar{width:100%;height:12px;border-radius:999px;background:rgba(0,0,0,0.04);overflow:hidden}
    .progress-bar > i{display:block;height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent-2));transition:width .48s}
    .result-card{margin-top:12px;background:var(--card-bg);padding:12px;border-radius:10px;border:1px solid rgba(0,0,0,0.04);white-space:pre-wrap;color:var(--muted)}
    .typing::after{content:'▍';margin-left:6px;color:var(--accent);animation:blink 1s steps(2,end) infinite}
    @keyframes blink{0%,49%{opacity:1}50%,100%{opacity:0}}
    .toast{position:fixed;right:20px;bottom:20px;padding:10px 14px;border-radius:10px;color:#fff;background:linear-gradient(90deg,var(--accent),var(--accent-2));box-shadow:var(--shadow-1);z-index:9999}
    .reference-link{display:block;padding:6px 0;color:var(--accent);text-decoration:none;font-size:13px;line-height:1.4;border-bottom:1px solid rgba(0,0,0,0.04)}
    .reference-link:hover{text-decoration:underline}
    .reference-link:last-child{border-bottom:none}
    .summary-item{margin-bottom:8px;font-size:13px;line-height:1.5}
    .summary-label{font-weight:600;color:var(--text);display:inline-block;min-width:90px}
    @media (max-width:980px){ .container{grid-template-columns:1fr} .header-controls{margin-left:0} }
  </style>
</head>
<body>
  <main class="container" role="main" aria-labelledby="pageTitle">
    <div class="brand">
      <div class="logo" title="Form Checker">
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><circle cx="12" cy="12" r="10" fill="white" opacity="0.08"/><rect x="5.5" y="10.2" width="13" height="3.6" rx="1.8" fill="#fff" opacity="0.9"/></svg>
      </div>
      <div class="title">
        <h1 id="pageTitle">Workout Form Checker</h1>
        <p>Clear, actionable guidance to keep training safe and effective</p>
      </div>

      <div class="header-controls" role="toolbar" aria-label="Theme and quick actions">
        <button id="themeToggle" class="theme-toggle" aria-pressed="false"><span id="themeIcon">☀️</span> <span id="themeLabel">Light</span></button>
      </div>
    </div>

    <section class="card input-area" aria-labelledby="describeHeading">
      <h2 id="describeHeading">Describe what happened</h2>
      <p class="hint">Be specific about the exercise, movement, when pain occurred, and which side is affected.</p>

      <textarea id="userInput" placeholder="E.g. Squats — felt a sharp twinge ..." aria-label="Describe your workout issue"></textarea>

      <div class="suggestions" id="suggestions">
        <button class="chip" data-sample="Squats — pain behind the knee on ascent">Squat — behind knee</button>
        <button class="chip" data-sample="Deadlift — lower back stiffness next day">Deadlift — lower back</button>
        <button class="chip" data-sample="Bench press — shoulder ache while lowering">Bench — shoulder ache</button>
        <button class="chip" data-sample="Lunge — sharp pain in front of knee">Lunge — front knee</button>
      </div>

      <div class="controls" role="group" aria-label="actions">
        <button id="runMasterBtn" class="btn" onclick="runMasterAndShow()">Generate Analysis Report</button>
        <button id="clearBtn" class="btn secondary" onclick="clearInput()">Clear</button>
      </div>

      <div id="output" aria-live="polite"></div>
    </section>

    <aside class="panel" aria-labelledby="panelHeading">
      <!-- Agent Pipeline -->
      <div class="mini progress-wrap">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div style="font-weight:600;color:var(--text)">Agent Pipeline</div>
          <div id="progressPercent" style="font-size:13px;color:var(--muted)">0%</div>
        </div>

        <div class="progress-bar" role="progressbar"><i id="progressFill"></i></div>

        <ul style="list-style:none;margin:10px 0 0 0;padding:0;font-size:13px;color:var(--muted);line-height:1.6">
          <li>💡 Step 0 — Initiate reasoning loop</li>
          <li>🧠 Step 1 — Interpret workout description</li>
          <li>🎯 Step 2 — Identify form deviations</li>
          <li>🩺 Step 3 — Diagnose likely injury</li>
          <li>🔍 Step 4 — Cross-check medical research</li>
          <li>📋 Step 5 — Generate recovery plan</li>
          <li>🪞 Step 6 — Reflect and refine if confidence is low</li>
        </ul>
      </div>

      <!-- References Section (replaces "When to see a clinician") -->
      <div class="mini" id="referencesPanel">
        <strong style="color:var(--text);font-size:15px;">📚 References</strong>
        <div id="referencesContent" style="margin-top:8px;font-size:13px;color:var(--muted)">
          Run an analysis to see research sources...
        </div>
      </div>

      <!-- Summary Section (replaces "System Overview") -->
      <div class="mini" id="summaryPanel">
        <strong style="color:var(--text);font-size:15px;">📊 Summary</strong>
        <div id="summaryContent" style="margin-top:8px;font-size:13px;color:var(--muted)">
          Run an analysis to see key findings...
        </div>
      </div>
    </aside>

  </main>

  <script>
    // -- theme code (keeps previous behavior) --
    const themeToggleBtn = document.getElementById('themeToggle');
    const themeLabel = document.getElementById('themeLabel');
    const themeIcon = document.getElementById('themeIcon');
    (function initTheme(){
      const stored = (function(){ try { return localStorage.getItem('preferredTheme'); } catch(e){ return null; }})();
      const systemPrefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      const initial = stored || (systemPrefersDark ? 'dark' : 'light');
      applyTheme(initial, false);
      themeToggleBtn && themeToggleBtn.addEventListener('click', () => {
        const current = document.documentElement.getAttribute('data-theme') || 'light';
        const next = current === 'dark' ? 'light' : 'dark';
        applyTheme(next, true);
      });
    })();

    function applyTheme(theme, persist){
      if(theme === 'dark'){
        document.documentElement.setAttribute('data-theme','dark');
        themeLabel.textContent = 'Dark';
        themeIcon.textContent = '🌙';
        themeToggleBtn && themeToggleBtn.setAttribute('aria-pressed','true');
      } else {
        document.documentElement.setAttribute('data-theme','light');
        themeLabel.textContent = 'Light';
        themeIcon.textContent = '☀️';
        themeToggleBtn && themeToggleBtn.setAttribute('aria-pressed','false');
      }
      if(persist){
        try { localStorage.setItem('preferredTheme', theme); } catch(e) {}
      }
    }

    // -- existing analysis UI wiring (kept as-is) --
    const analyzeBtn = document.getElementById('analyzeBtn');
    const runMasterBtn = document.getElementById('runMasterBtn');
    const clearBtn = document.getElementById('clearBtn');
    const userInput = document.getElementById('userInput');
    const output = document.getElementById('output');
    const progressFill = document.getElementById('progressFill');

    document.getElementById('suggestions').addEventListener('click', (e) => {
      const btn = e.target.closest('.chip');
      if(!btn) return;
      userInput.value = btn.dataset.sample || btn.textContent;
      userInput.focus();
    });

    function clearInput(){
      userInput.value = '';
      output.innerHTML = '';
      updateProgress(0);
      // Reset sidebar panels
      document.getElementById('referencesContent').innerHTML = 'Run an analysis to see research sources...';
      document.getElementById('summaryContent').innerHTML = 'Run an analysis to see key findings...';
    }
    function setBtnState(isBusy){
      if(analyzeBtn) analyzeBtn.disabled = isBusy;
      runMasterBtn.disabled = isBusy;
      clearBtn.disabled = isBusy;
      if(analyzeBtn) analyzeBtn.textContent = isBusy ? 'Analyzing…' : 'Analyze';
    }
    function updateProgress(p){
      const f = document.getElementById('progressFill');
      if(f) f.style.width = p + '%';
      const pp = document.getElementById('progressPercent');
      if(pp) pp.textContent = p + '%';
    }

    function animateProgress(duration = 4000) {
      const bar = document.getElementById("progressFill");
      const percentText = document.getElementById("progressPercent");
      let startTime = null;

      function step(timestamp) {
        if (!startTime) startTime = timestamp;
        const progress = Math.min((timestamp - startTime) / duration, 1);
        const percent = Math.floor(progress * 100);
        bar.style.width = percent + "%";
        percentText.textContent = percent + "%";

        if (progress < 1) {
          requestAnimationFrame(step);
        }
      }
      requestAnimationFrame(step);
    }

    // NEW: Function to populate sidebar with analysis results
    function updateSidebar(result) {
      // Update References
      const referencesContent = document.getElementById('referencesContent');
      const webResults = result.web_results || [];
      const sources = result.web_sources || [];
      
      if (webResults.length > 0) {
        let refsHTML = '';
        webResults.forEach((item, idx) => {
          const title = item.title || `Source ${idx + 1}`;
          const url = item.url || '#';
          refsHTML += `<a href="${escapeHtml(url)}" target="_blank" class="reference-link">${escapeHtml(title)}</a>`;
        });
        referencesContent.innerHTML = refsHTML;
      } else if (sources.length > 0) {
        let refsHTML = '';
        sources.forEach((url, idx) => {
          refsHTML += `<a href="${escapeHtml(url)}" target="_blank" class="reference-link">Source ${idx + 1}</a>`;
        });
        referencesContent.innerHTML = refsHTML;
      } else {
        referencesContent.innerHTML = 'No external sources found in this analysis.';
      }

      // Update Summary
      const summaryContent = document.getElementById('summaryContent');
      const diagnosis = result.diagnosis || 'Not available';
      const parsedData = result.parsed_data || {};
      const exercise = parsedData.exercise || 'Unknown';
      const painLocation = parsedData.pain_location || 'Unknown';
      
      // Extract first line of diagnosis for brevity
      const diagnosisShort = diagnosis.split('\n')[0].substring(0, 120) + '...';
      
      const summaryHTML = `
        <div class="summary-item">
          <span class="summary-label">Exercise:</span> ${escapeHtml(exercise)}
        </div>
        <div class="summary-item">
          <span class="summary-label">Pain Area:</span> ${escapeHtml(painLocation)}
        </div>
        <div class="summary-item">
          <span class="summary-label">Diagnosis:</span> ${escapeHtml(diagnosisShort)}
        </div>
        <div class="summary-item">
          <span class="summary-label">Medical Attention:</span> ${result.requires_medical_attention ? '⚠️ Recommended' : '✓ Not urgent'}
        </div>
      `;
      summaryContent.innerHTML = summaryHTML;
    }

    async function runMasterAndShow(){
      setBtnState(true);
      const outEl = output;
      outEl.innerHTML = `<div class="result-card">Running master.py… <span style="opacity:.7">This uses the server import path by default (fastest). If import fails, server will run subprocess fallback.</span></div>`;
      const progressPromise = animateProgress(17500);
      
      try {
        const userInputText = document.getElementById("userInput").value.trim();
        
        const resp = await fetch('https://rebeca-groutiest-incorporeally.ngrok-free.dev/run', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ input: userInputText })
        });

        const data = await resp.json();
        updateProgress(100);
        
        if (data.ok) {
          const pretty = data.printed || JSON.stringify(data.result, null, 2);
          outEl.innerHTML = `
            <div class="result-card">
              <div style="font-weight:700;font-size:15px;color:var(--text)">Master.py Console Output</div>
              <pre style="margin-top:10px;white-space:pre-wrap;color:var(--muted)">${escapeHtml(pretty)}</pre>
            </div>
          `;
          
          // NEW: Update sidebar with results
          if (data.result) {
            updateSidebar(data.result);
          }
        } else {
          const body = data.output && data.output.length ? data.output : '(no output)';
          outEl.innerHTML = `
            <div class="result-card" id="analysisCard">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div style="font-weight:700;font-size:15px;color:var(--text)">master.py output</div>
                <div style="font-size:12px;color:var(--muted)">${escapeHtml((data.elapsed_ms||0) + 'ms')}</div>
              </div>
              <pre id="masterOutput" style="margin-top:10px;color:var(--muted);white-space:pre-wrap">${escapeHtml(body)}</pre>
              <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
                <button id="copyBtn" class="btn secondary" style="min-width:84px">Copy</button>
                <button id="saveBtn" class="btn" style="min-width:84px">Save</button>
              </div>
            </div>
          `;
          document.getElementById('copyBtn').addEventListener('click', async () => {
            try { await navigator.clipboard.writeText(body); flashNotice('Copied to clipboard'); } catch(e){ flashNotice('Unable to copy'); }
          });
          document.getElementById('saveBtn').addEventListener('click', () => {
            try { localStorage.setItem('lastPlan', body); flashNotice('Saved locally'); } catch(e){ flashNotice('Unable to save'); }
          });
        }
      } catch (err) {
        outEl.innerHTML = `<div class="result-card">Request failed: ${escapeHtml(err.message || String(err))}</div>`;
      } finally {
        updateProgress(100);
        setBtnState(false);
      }
    }

    function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
    function flashNotice(msg){
      const t = document.createElement('div'); t.className='toast'; t.textContent = msg; document.body.appendChild(t);
      setTimeout(()=>{ t.style.opacity='0'; t.style.transform='translateY(6px)'; }, 1400);
      setTimeout(()=> t.remove(), 2200);
    }

    // Initialize small UI state
    (function init(){ updateProgress(0); })();
    // Expose functions for inline handlers
    window.clearInput = clearInput;
    window.runMasterAndShow = runMasterAndShow;
  </script>
</body>
</html>
